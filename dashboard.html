
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard de Avaliações</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body class="bg-light">
  <div class="container py-5">
    <h2 class="mb-4">Dashboard de Avaliações</h2>

    <div class="row mb-3">
      <div class="col-md-3">
        <label>Data início:</label>
        <input type="date" id="dataInicio" class="form-control">
      </div>
      <div class="col-md-3">
        <label>Data fim:</label>
        <input type="date" id="dataFim" class="form-control">
      </div>
      <div class="col-md-3">
        <label>Tipo de Avaliação:</label>
        <select id="tipoAvaliacao" class="form-control">
          <option value="">Todos</option>
          <option value="Muito bom">Muito bom</option>
          <option value="Bom">Bom</option>
          <option value="Regular">Regular</option>
          <option value="Ruim">Ruim</option>
        </select>
      </div>
      <div class="col-md-3 d-flex align-items-end flex-wrap">
        <button class="btn btn-primary me-2 mb-2" onclick="filtrarDados()">Filtrar</button>
        <button class="btn btn-secondary me-2 mb-2" onclick="limparFiltros()">Limpar</button>
        <button class="btn btn-success me-2 mb-2" onclick="exportarParaExcel()">Exportar Excel</button>
        <button class="btn btn-danger mb-2" onclick="exportarPDF()">Exportar PDF</button>
      </div>
    </div>

    <table class="table table-bordered bg-white">
      <thead class="table-light">
        <tr>
          <th>Nome</th>
          <th>Avaliação</th>
          <th>Data</th>
        </tr>
      </thead>
      <tbody id="tabelaAvaliacoes"></tbody>
    </table>
  </div>

  <script>
    let dadosOriginais = [];

    async function carregarAvaliacoes() {
      try {
        const resposta = await fetch('https://avaliation.onrender.com/avaliacoes');
        const dados = await resposta.json();
        dadosOriginais = dados;
        carregarTabela(dados);
      } catch (erro) {
        console.error("Erro ao carregar avaliações:", erro);
      }
    }

    function carregarTabela(lista) {
      const corpo = document.getElementById('tabelaAvaliacoes');
      corpo.innerHTML = '';
      lista.forEach(item => {
        const linha = `<tr>
          <td>${item.nome || '-'}</td>
          <td>${item.avaliacao}</td>
          <td>${new Date(item.data).toLocaleDateString()}</td>
        </tr>`;
        corpo.innerHTML += linha;
      });
    }

    function filtrarDados() {
      const inicioStr = document.getElementById('dataInicio').value;
      const fimStr = document.getElementById('dataFim').value;
      const tipo = document.getElementById('tipoAvaliacao').value;

      const inicio = inicioStr ? new Date(inicioStr + 'T00:00:00') : null;
      const fim = fimStr ? new Date(fimStr + 'T23:59:59') : null;

      const filtrados = dadosOriginais.filter(item => {
        const dataItem = new Date(item.data);
        const condData = (!inicio || dataItem >= inicio) && (!fim || dataItem <= fim);
        const condTipo = !tipo || item.avaliacao === tipo;
        return condData && condTipo;
      });

      carregarTabela(filtrados);
    }

    function limparFiltros() {
      document.getElementById('dataInicio').value = '';
      document.getElementById('dataFim').value = '';
      document.getElementById('tipoAvaliacao').value = '';
      carregarTabela(dadosOriginais);
    }

    function exportarParaExcel() {
      const tabela = document.getElementById('tabelaAvaliacoes');
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.table_to_sheet(tabela);
      ws['!cols'] = [{ wch: 20 }, { wch: 15 }, { wch: 15 }];
      XLSX.utils.book_append_sheet(wb, ws, "Avaliações");
      XLSX.writeFile(wb, "avaliacoes.xlsx");
    }

      async function exportarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(18);
      doc.text("Relatório de Avaliações", 105, 15, { align: "center" });

      const table = [];
      const headers = [["Nome", "Avaliação", "Data"]];
      const rows = [...document.querySelectorAll("#tabelaAvaliacoes tr")];

      rows.forEach(tr => {
        const cols = tr.querySelectorAll("td");
        if (cols.length)
          table.push([cols[0].innerText, cols[1].innerText, cols[2].innerText]);
      });

      async function exportarGraficoPDF() {
      const chartContainer = document.querySelector('#grafico');
      const canvas = await html2canvas(chartContainer);
      
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
  
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const imgProps = pdf.getImageProperties(imgData);
      const pdfWidth = pageWidth - 20;
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
  
      pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth, pdfHeight);
      pdf.save("grafico-avaliacoes.pdf");
    }

      doc.autoTable({
        head: headers,
        body: table,
        startY: 25,
        theme: 'grid',
        styles: { fontSize: 12 },
        headStyles: { fillColor: [52, 58, 64] }
      });

      doc.save("relatorio-avaliacoes.pdf");
    }

    carregarAvaliacoes();
  </script>
</body>
</html>
