<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <span class="navbar-brand">⚙️ Painel do Sistema</span>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="mostrarSessao('relatorio')">🧾 Relatório</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="mostrarSessao('usuarios')">👤 Usuários</a>
          </li>
        </ul>
        <span class="navbar-text me-3" id="saudacao">👋 Olá, Usuário</span>
        <button class="btn btn-outline-light btn-sm" onclick="logout()">🚪 Sair</button>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <div id="telaInicial" class="text-center">
      <h3>🙋🏻‍♂️ Bem-vindo à sua dashboard!</h3>
      <p>▶️ Escolha uma das opções acima para começar.</p>
    </div>

    <div id="secaoRelatorio" style="display:none">
      <ul class="nav nav-tabs">
        <li class="nav-item">
          <a class="nav-link active" data-bs-toggle="tab" href="#abaLista">🧾 Relatório</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-bs-toggle="tab" href="#abaGrafico">📊 Gráfico</a>
        </li>
      </ul>
      <div class="tab-content mt-3">
        <div class="tab-pane fade show active" id="abaLista">
          <div class="row mb-3">
            <div class="col-md-3">
              <label>Data início:</label>
              <input type="date" id="dataInicio" class="form-control">
            </div>
            <div class="col-md-3">
              <label>Data fim:</label>
              <input type="date" id="dataFim" class="form-control">
            </div>
            <div class="col-md-3">
              <label>Tipo de Avaliação:</label>
              <select id="tipoAvaliacao" class="form-control">
                <option value="">Todos</option>
                <option value="Muito bom">Muito bom</option>
                <option value="Bom">Bom</option>
                <option value="Regular">Regular</option>
                <option value="Ruim">Ruim</option>
              </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <button class="btn btn-primary me-2" onclick="filtrarDados()">Filtrar</button>
              <button class="btn btn-secondary me-2" onclick="limparFiltros()">Limpar</button>
              <button class="btn btn-success me-2" onclick="exportarParaExcel()">Excel</button>
              <button class="btn btn-danger" onclick="exportarPDF()">PDF</button>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-bordered bg-white">
              <thead class="table-light">
                <tr>
                  <th>Nome</th>
                  <th>Avaliação</th>
                  <th>Data</th>
                </tr>
              </thead>
              <tbody id="tabelaAvaliacoes"></tbody>
            </table>
          </div>
        </div>

        <div class="tab-pane fade" id="abaGrafico">
          <canvas id="graficoAvaliacoes" height="150"></canvas>
          <p class="mt-2"><strong>🕙 Última atualização:</strong> <span id="ultimaData"></span></p>
          <button class="btn btn-outline-danger mt-2" onclick="exportarGraficoPDF()">PDF</button>
        </div>
      </div>
    </div>

    <div id="secaoUsuarios" style="display:none">
      <div class="d-flex justify-content-between mb-3">
        <h5>👤 Usuários ativos</h5>
        <button class="btn btn-sm btn-success">➕ Novo Usuário</button>
      </div>
      <table class="table table-bordered">
        <thead class="table-light">
          <tr>
            <th>Nome</th>
            <th>Usuário</th>
            <th>Email</th>
            <th>🪛 Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Usuário Exemplo</td>
            <td>user</td>
            <td>user@email.com</td>
            <td>
              <button class="btn btn-sm btn-primary">✏️ Editar</button>
              <button class="btn btn-sm btn-danger">❌ Desativar</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    let dadosOriginais = [];
    let chart;

    function mostrarSessao(sessao) {
      document.getElementById('telaInicial').style.display = 'none';
      document.getElementById('secaoRelatorio').style.display = sessao === 'relatorio' ? 'block' : 'none';
      document.getElementById('secaoUsuarios').style.display = sessao === 'usuarios' ? 'block' : 'none';
    }

    function logout() {
      localStorage.removeItem('usuarioLogado');
      window.location.href = 'login.html';
    }

    function carregarAvaliacoes() {
      fetch("https://avaliation.onrender.com/avaliacoes")
        .then(res => res.json())
        .then(data => {
          dadosOriginais = data;
          carregarTabela(data);
          atualizarGrafico(data);
        });
    }

    function carregarTabela(lista) {
      const corpo = document.getElementById('tabelaAvaliacoes');
      corpo.innerHTML = '';
      lista.forEach(item => {
        const linha = `<tr>
          <td>${item.nome || '-'}</td>
          <td>${item.avaliacao}</td>
          <td>${new Date(item.data).toLocaleDateString()}</td>
        </tr>`;
        corpo.innerHTML += linha;
      });
    }

    function filtrarDados() {
      const inicio = new Date(document.getElementById('dataInicio').value + 'T00:00:00');
      const fim = new Date(document.getElementById('dataFim').value + 'T23:59:59');
      const tipo = document.getElementById('tipoAvaliacao').value;
      const filtrados = dadosOriginais.filter(item => {
        const data = new Date(item.data);
        const dentroData = (!isNaN(inicio) ? data >= inicio : true) && (!isNaN(fim) ? data <= fim : true);
        const mesmoTipo = !tipo || item.avaliacao === tipo;
        return dentroData && mesmoTipo;
      });
      carregarTabela(filtrados);
      atualizarGrafico(filtrados);
    }

    function limparFiltros() {
      document.getElementById('dataInicio').value = '';
      document.getElementById('dataFim').value = '';
      document.getElementById('tipoAvaliacao').value = '';
      carregarTabela(dadosOriginais);
      atualizarGrafico(dadosOriginais);
    }

    function exportarParaExcel() {
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.table_to_sheet(document.querySelector("table"));
      XLSX.utils.book_append_sheet(wb, ws, "Avaliacoes");
      XLSX.writeFile(wb, "relatorio_avaliacoes.xlsx");
    }

    function exportarPDF() {
      const doc = new jspdf.jsPDF();
      doc.setFontSize(16);
      doc.text("Relatório de Avaliações", 14, 20);
      const tableRows = [['Nome', 'Avaliação', 'Data']];
      const rows = [...document.querySelectorAll("#tabelaAvaliacoes tr")];
      rows.forEach(tr => {
        const cols = tr.querySelectorAll("td");
        if (cols.length)
          tableRows.push([cols[0].innerText, cols[1].innerText, cols[2].innerText]);
      });
      let y = 30;
      tableRows.forEach(row => {
        doc.text(row.join("   "), 14, y);
        y += 10;
      });
      doc.save("relatorio-avaliacoes.pdf");
    }

    function atualizarGrafico(dados) {
      const contagem = { 'Muito bom': 0, 'Bom': 0, 'Regular': 0, 'Ruim': 0 };
      dados.forEach(d => contagem[d.avaliacao]++);
      const total = Object.values(contagem).reduce((a, b) => a + b, 0);
      const porcentagens = Object.values(contagem).map(q => ((q / total) * 100).toFixed(1));
      const labels = Object.keys(contagem);
      const cores = ['#198754', '#0dcaf0', '#ffc107', '#dc3545'];

      const ctx = document.getElementById('graficoAvaliacoes').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Quantidade de Avaliações',
            data: Object.values(contagem),
            backgroundColor: cores
          }]
        },
        options: {
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => `Qtd: ${ctx.raw} (${porcentagens[ctx.dataIndex]}%)`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Total' }
            }
          }
        }
      });

      const ultimaData = dados.length ? new Date(Math.max(...dados.map(d => new Date(d.data)))).toLocaleString() : '-';
      document.getElementById("ultimaData").textContent = ultimaData;
    }

    function exportarGraficoPDF() {
      html2canvas(document.getElementById("graficoAvaliacoes")).then(canvas => {
        const imgData = canvas.toDataURL("image/png");
        const pdf = new jspdf.jsPDF();
        pdf.addImage(imgData, "PNG", 10, 10, 190, 100);
        pdf.save("grafico_avaliacoes.pdf");
      });
    }

    window.onload = () => {
      const usuario = JSON.parse(localStorage.getItem('usuarioLogado'));
      if (!usuario) return window.location.href = 'login.html';
      document.getElementById('saudacao').innerText = `Olá, ${usuario.nome}`;
      carregarAvaliacoes();
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
