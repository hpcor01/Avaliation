<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .navbar-nav .nav-link {
      color: white !important;
    }
    #loadingMsg {
      display: none;
      font-weight: bold;
      text-align: center;
      margin: 20px 0;
    }
  </style>
</head>
<body class="bg-light">
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <span class="navbar-brand"><i class="bi bi-gear"></i> Painel do Sistema</span>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="mostrarSessao('relatorio')"><i class="bi bi-file-earmark-text"></i> RelatÃ³rio</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="mostrarSessao('usuarios')"><i class="bi bi-person"></i> UsuÃ¡rios</a>
          </li>
        </ul>
        <span class="navbar-text me-3 text-white" id="saudacao"><i class="bi bi-hand-index-thumb"></i> OlÃ¡, UsuÃ¡rio</span>
        <button class="btn btn-outline-danger btn-sm" onclick="logout()"><i class="bi bi-box-arrow-right"></i> Sair</button>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <div id="telaInicial" class="text-center">
      <h3>ğŸ™‹ğŸ»â€â™‚ Bem-vindo Ã  sua dashboard!</h3>
      <p>â–¶ï¸ Escolha uma das opÃ§Ãµes acima para comeÃ§ar.</p>
    </div>

    <div id="loadingMsg">âŒ› Carregando dados...</div>

    <div id="secaoRelatorio" style="display:none">
      <ul class="nav nav-tabs">
        <li class="nav-item">
          <a class="nav-link active" data-bs-toggle="tab" href="#abaLista">ğŸ“ƒ RelatÃ³rio</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-bs-toggle="tab" href="#abaGrafico">ğŸ“Š GrÃ¡fico</a>
        </li>
      </ul>
      <div class="tab-content mt-3">
        <div class="tab-pane fade show active" id="abaLista">
          <table class="table table-bordered mt-3">
            <thead><tr><th>Nome</th><th>AvaliaÃ§Ã£o</th><th>Data</th></tr></thead>
            <tbody id="tabelaAvaliacao"></tbody>
          </table>
        </div>
        <div class="tab-pane fade" id="abaGrafico">
          <canvas id="graficoAvaliacao" height="100"></canvas>
        </div>
      </div>
    </div>

    <div id="secaoUsuarios" style="display:none">
      <div class="d-flex justify-content-between mb-3">
        <h5>ğŸ‘¤ UsuÃ¡rios ativos</h5>
        <button class="btn btn-sm btn-success">â• Novo UsuÃ¡rio</button>
      </div>
      <table class="table table-bordered">
        <thead class="table-light">
          <tr><th>Nome</th><th>UsuÃ¡rio</th><th>Email</th><th>ğŸª› AÃ§Ãµes</th></tr>
        </thead>
        <tbody id="listaUsuarios"></tbody>
      </table>
    </div>
  </div>

  <script>
    const API = 'https://avaliation.onrender.com';
  
    function mostrarSessao(sessao) {
      document.getElementById('telaInicial').style.display = 'none';
      document.getElementById('secaoRelatorio').style.display = sessao === 'relatorio' ? 'block' : 'none';
      document.getElementById('secaoUsuarios').style.display = sessao === 'usuarios' ? 'block' : 'none';
      document.getElementById('loadingMsg').style.display = 'block';
  
      if (sessao === 'relatorio') carregarRelatorio();
      if (sessao === 'usuarios') carregarUsuarios();
    }

    window.onload = () => {
        const usuario = JSON.parse(localStorage.getItem('usuarioLogado'));
        if (!usuario) return window.location.href = 'login.html';
        document.getElementById('saudacao').innerText = `ğŸ‘‹ OlÃ¡, ${usuario.nome}`;
    }
    
    function logout() {
      localStorage.removeItem('usuarioLogado');
      window.location.href = 'login.html';
    }
  
    function carregarRelatorio() {
      fetch(`${API}/avaliacoes`).then(res => res.json()).then(data => {
        const tbody = document.getElementById('tabelaAvaliacao');
        tbody.innerHTML = '';
        const contagem = { 'Muito bom': 0, 'Bom': 0, 'Regular': 0, 'Ruim': 0 };
  
        data.forEach(item => {
          const row = `<tr><td>${item.nome}</td><td>${item.avaliacao}</td><td>${new Date(item.data).toLocaleString()}</td></tr>`;
          tbody.innerHTML += row;
          contagem[item.avaliacao]++;
        });
  
        atualizarGrafico(contagem);
        document.getElementById('loadingMsg').style.display = 'none';
      });
    }
  
    function atualizarGrafico(dados) {
      const ctx = document.getElementById('graficoAvaliacao');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(dados),
          datasets: [{
            label: 'Quantidade',
            data: Object.values(dados),
            backgroundColor: ['#28a745', '#8bc34a', '#ffc107', '#dc3545']
          }]
        }
      });
    }
  
    function carregarUsuarios() {
      fetch(`${API}/usuarios`).then(res => res.json()).then(data => {
        const lista = document.getElementById('listaUsuarios');
        lista.innerHTML = '';
        data.forEach(u => {
          const linha = `<tr><td>${u.nome}</td><td>${u.username}</td><td>${u.email}</td>
            <td><button class='btn btn-sm btn-primary'>Editar</button>
            <button class='btn btn-sm btn-danger'>Desativar</button></td></tr>`;
          lista.innerHTML += linha;
        });
        document.getElementById('loadingMsg').style.display = 'none';
      });
    }
  
      // Logout automÃ¡tico apÃ³s 15 minutos
      let logoutTimer;
      function resetInactivityTimer() {
        clearTimeout(logoutTimer);
        logoutTimer = setTimeout(() => {
          alert('SessÃ£o expirada por inatividade.');
          logout();
        }, 15 * 60 * 1000);
      }
      ['mousemove', 'keypress', 'click'].forEach(evt =>
        document.addEventListener(evt, resetInactivityTimer)
      );
      resetInactivityTimer();
  
      // Remove sessÃ£o ao fechar a aba
      window.addEventListener('beforeunload', () => {
        localStorage.removeItem('usuarioLogado');
      });
    };
</script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
