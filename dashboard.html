<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard de Avalia√ß√µes</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"/>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 class="mb-4">Dashboard de Avalia√ß√µes</h2>

    <!-- Abas -->
    <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="relatorio-tab" data-bs-toggle="tab" data-bs-target="#relatorio" type="button" role="tab">üìã Relat√≥rio</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="grafico-tab" data-bs-toggle="tab" data-bs-target="#grafico" type="button" role="tab">üìä Gr√°fico</button>
      </li>
    </ul>

    <div class="tab-content" id="myTabContent">
      <!-- Aba: Relat√≥rio -->
      <div class="tab-pane fade show active" id="relatorio" role="tabpanel">
        <div class="row mb-3">
          <div class="col-md-3">
            <label>Data in√≠cio:</label>
            <input type="date" id="dataInicio" class="form-control">
          </div>
          <div class="col-md-3">
            <label>Data fim:</label>
            <input type="date" id="dataFim" class="form-control">
          </div>
          <div class="col-md-3">
            <label>Tipo de Avalia√ß√£o:</label>
            <select id="tipoAvaliacao" class="form-control">
              <option value="">Todos</option>
              <option value="Muito bom">Muito bom</option>
              <option value="Bom">Bom</option>
              <option value="Regular">Regular</option>
              <option value="Ruim">Ruim</option>
            </select>
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-primary me-2" onclick="filtrarDados()">Filtrar</button>
            <button class="btn btn-secondary me-2" onclick="limparFiltros()">Limpar</button>
            <button class="btn btn-success me-2" onclick="exportarParaExcel()">Excel</button>
            <button class="btn btn-danger" onclick="exportarPDF()">PDF</button>
          </div>
        </div>

        <table class="table table-bordered bg-white">
          <thead class="table-light">
            <tr>
              <th>Nome</th>
              <th>Avalia√ß√£o</th>
              <th>Data</th>
            </tr>
          </thead>
          <tbody id="tabelaAvaliacoes"></tbody>
        </table>
      </div>

      <!-- Aba: Gr√°fico -->
      <div class="tab-pane fade" id="grafico" role="tabpanel">
        <canvas id="graficoAvaliacao" height="130"></canvas>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    let dadosOriginais = [];
    let chart;

    async function carregarAvaliacoes() {
      try {
        const res = await fetch('https://avaliation.onrender.com/avaliacoes');
        const dados = await res.json();
        dadosOriginais = dados;
        carregarTabela(dados);
        gerarGrafico(dados);
      } catch (err) {
        console.error("Erro ao carregar:", err);
      }
    }

    function carregarTabela(lista) {
      const tbody = document.getElementById('tabelaAvaliacoes');
      tbody.innerHTML = '';
      lista.forEach(item => {
        tbody.innerHTML += `
          <tr>
            <td>${item.nome || '-'}</td>
            <td>${item.avaliacao}</td>
            <td>${new Date(item.data).toLocaleDateString()}</td>
          </tr>`;
      });
    }

    function filtrarDados() {
      const inicio = new Date(document.getElementById('dataInicio').value + 'T00:00:00');
      const fim = new Date(document.getElementById('dataFim').value + 'T23:59:59');
      const tipo = document.getElementById('tipoAvaliacao').value;

      const filtrados = dadosOriginais.filter(item => {
        const dataItem = new Date(item.data);
        const okData = (!isNaN(inicio) ? dataItem >= inicio : true) && (!isNaN(fim) ? dataItem <= fim : true);
        const okTipo = tipo ? item.avaliacao === tipo : true;
        return okData && okTipo;
      });

      carregarTabela(filtrados);
      gerarGrafico(filtrados);
    }

    function limparFiltros() {
      document.getElementById('dataInicio').value = '';
      document.getElementById('dataFim').value = '';
      document.getElementById('tipoAvaliacao').value = '';
      carregarTabela(dadosOriginais);
      gerarGrafico(dadosOriginais);
    }

    function gerarGrafico(dados) {
      const counts = { 'Muito bom': 0, 'Bom': 0, 'Regular': 0, 'Ruim': 0 };
      dados.forEach(item => counts[item.avaliacao] = (counts[item.avaliacao] || 0) + 1);

      const ctx = document.getElementById('graficoAvaliacao').getContext('2d');
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(counts),
          datasets: [{
            label: 'Quantidade',
            data: Object.values(counts),
            backgroundColor: ['#198754', '#0d6efd', '#ffc107', '#dc3545'],
          }]
        },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    function exportarParaExcel() {
      const tabela = document.getElementById('tabelaAvaliacoes');
      const wb = XLSX.utils.table_to_book(tabela, { sheet: "Avalia√ß√µes" });
      XLSX.writeFile(wb, "avaliacoes.xlsx");
    }

    async function exportarPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("Relat√≥rio de Avalia√ß√µes", 14, 20);
      const tableRows = [['Nome', 'Avalia√ß√£o', 'Data']];
      const rows = [...document.querySelectorAll("#tabelaAvaliacoes tr")];
      rows.forEach(tr => {
        const cols = tr.querySelectorAll("td");
        if (cols.length)
          tableRows.push([cols[0].innerText, cols[1].innerText, cols[2].innerText]);
      });
      let y = 30;
      tableRows.forEach(row => {
        doc.text(row.join("   "), 14, y);
        y += 10;
      });
      doc.save("relatorio-avaliacoes.pdf");
    }

    carregarAvaliacoes();
  </script>
</body>
</html>
